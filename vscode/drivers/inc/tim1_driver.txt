#ifndef TIM1_DRIVER_H
#define TIM1_DRIVER_H

#include <stdint.h>

/* ============================================================
 * ===================== Типи і допоміжні =====================
 * ============================================================ */

typedef enum
{
    DISABLE = 0,
    ENABLE  = 1
} FunctionalState;

/* ============================================================
 * ===================== REGISTERS =============================
 * ============================================================ */

/* TIM1 Control */
#define TIM1_CR1    (*(volatile uint8_t *)0x5250)
#define TIM1_CR2    (*(volatile uint8_t *)0x5251)
#define TIM1_SMCR   (*(volatile uint8_t *)0x5252)

/* TIM1 Capture/Compare Mode */
#define TIM1_CCMR1  (*(volatile uint8_t *)0x5258)
#define TIM1_CCMR2  (*(volatile uint8_t *)0x5259)
#define TIM1_CCMR4  (*(volatile uint8_t *)0x525B)

/* TIM1 Capture/Compare Enable */
#define TIM1_CCER1  (*(volatile uint8_t *)0x525C)
#define TIM1_CCER2  (*(volatile uint8_t *)0x525D)

/* TIM1 Counter */
#define TIM1_CNTRH  (*(volatile uint8_t *)0x525E)
#define TIM1_CNTRL  (*(volatile uint8_t *)0x525F)

/* TIM1 Prescaler */
#define TIM1_PSCRH  (*(volatile uint8_t *)0x5260)
#define TIM1_PSCRL  (*(volatile uint8_t *)0x5261)

/* TIM1 Auto-reload */
#define TIM1_ARRH   (*(volatile uint8_t *)0x5262)
#define TIM1_ARRL   (*(volatile uint8_t *)0x5263)

/* TIM1 Repetition counter */
#define TIM1_RCR    (*(volatile uint8_t *)0x5264)

/* TIM1 Capture/Compare 4 */
#define TIM1_CCR4H  (*(volatile uint8_t *)0x526B)
#define TIM1_CCR4L  (*(volatile uint8_t *)0x526C)

/* TIM1 Break / Main output */
#define TIM1_BKR    (*(volatile uint8_t *)0x526D)

/* TIM1 Output Idle State */
#define TIM1_OISR   (*(volatile uint8_t *)0x526F)

/* ============================================================
 * ================= BIT MASKS ================================
 * ============================================================ */

#define TIM1_CR1_CEN        (1 << 0)
#define TIM1_CR1_DIR        (1 << 4)
#define TIM1_CR1_ARPE       (1 << 7)
#define TIM1_CR1_CMS        (3 << 5)

#define TIM1_CCMR_OCM       (7 << 4)
#define TIM1_CCMR_OCxPE     (1 << 3)
#define TIM1_CCMR_CCxS      (3 << 0)

#define TIM1_CCER1_CC1P     (1 << 1)
#define TIM1_CCER1_CC2P     (1 << 5)

#define TIM1_CCER2_CC4E     (1 << 0)
#define TIM1_CCER2_CC4P     (1 << 1)

#define TIM1_BKR_MOE        (1 << 7)
#define TIM1_OISR_OIS4      (1 << 6)

/* ============================================================
 * ================= ENUM DEFINITIONS =========================
 * ============================================================ */

/* TIM1 Counter Mode */
typedef enum
{
    TIM1_COUNTERMODE_UP = 0,
    TIM1_COUNTERMODE_DOWN = 1,
    TIM1_COUNTERMODE_CENTERALIGNED1 = 2,
    TIM1_COUNTERMODE_CENTERALIGNED2 = 3,
    TIM1_COUNTERMODE_CENTERALIGNED3 = 4
} TIM1_CounterMode_TypeDef;

/* TIM1 Output Compare Mode */
typedef enum
{
    TIM1_OCMODE_TIMING = 0,
    TIM1_OCMODE_ACTIVE = 1,
    TIM1_OCMODE_INACTIVE = 2,
    TIM1_OCMODE_TOGGLE = 3,
    TIM1_OCMODE_PWM1 = 4,
    TIM1_OCMODE_PWM2 = 5
} TIM1_OCMode_TypeDef;

/* Output State */
typedef enum
{
    TIM1_OUTPUTSTATE_DISABLE = 0,
    TIM1_OUTPUTSTATE_ENABLE = 1
} TIM1_OutputState_TypeDef;

/* OC Polarity */
typedef enum
{
    TIM1_OCPOLARITY_HIGH = 0,
    TIM1_OCPOLARITY_LOW = 1
} TIM1_OCPolarity_TypeDef;

/* OC Idle State */
typedef enum
{
    TIM1_OCIDLESTATE_RESET = 0,
    TIM1_OCIDLESTATE_SET = 1
} TIM1_OCIdleState_TypeDef;

/* Encoder Mode */
typedef enum
{
    TIM1_ENCODERMODE_TI1 = 0,
    TIM1_ENCODERMODE_TI2 = 1,
    TIM1_ENCODERMODE_TI12 = 2
} TIM1_EncoderMode_TypeDef;

/* Input Capture Polarity */
typedef enum
{
    TIM1_ICPOLARITY_RISING = 0,
    TIM1_ICPOLARITY_FALLING = 1
} TIM1_ICPolarity_TypeDef;

/* ============================================================
 * ================= FUNCTION PROTOTYPES ======================
 * ============================================================ */

/* Base */
void TIM1_TimeBaseInit(uint16_t TIM1_Prescaler,
                       TIM1_CounterMode_TypeDef TIM1_CounterMode,
                       uint16_t TIM1_Period,
                       uint8_t TIM1_RepetitionCounter);

/* PWM / Output Compare */
void TIM1_OC4Init(TIM1_OCMode_TypeDef TIM1_OCMode,
                  TIM1_OutputState_TypeDef TIM1_OutputState,
                  uint16_t TIM1_Pulse,
                  TIM1_OCPolarity_TypeDef TIM1_OCPolarity,
                  TIM1_OCIdleState_TypeDef TIM1_OCIdleState);

/* Preload */
void TIM1_OC4PreloadConfig(FunctionalState NewState);
void TIM1_ARRPreloadConfig(FunctionalState NewState);

/* Control */
void TIM1_Cmd(FunctionalState NewState);
void TIM1_CtrlPWMOutputs(FunctionalState NewState);

/* Compare */
void TIM1_SetCompare4(uint16_t Compare4);

/* Encoder */
void TIM1_EncoderInterfaceConfig(TIM1_EncoderMode_TypeDef TIM1_EncoderMode,
                                 TIM1_ICPolarity_TypeDef TIM1_IC1Polarity,
                                 TIM1_ICPolarity_TypeDef TIM1_IC2Polarity);

/* Counter */
uint16_t TIM1_GetCounter(void);
void TIM1_SetCounter(uint16_t Counter);
uint16_t TIM1_GetPrescaler(void);

#endif /* STM8_S_TIM1_H */
